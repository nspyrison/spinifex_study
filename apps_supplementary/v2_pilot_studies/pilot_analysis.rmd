---
title: "Pilot study analysis"
author: "Nick Spyrison"
date: "1/15/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
# ss_id <- "1K9qkMVRkrNO0vufofQJKWIJUyTys_8uVtEBdJBL_DzU" ## hash or name of the google sheet
# raw <- googlesheets4::read_sheet(ss_id, sheet = 1L)
# saveRDS(raw, here::here("raw_nick_pilot.rds"))
# readRDS("./apps/study/v2_pilot_studies/raw_nick_pilot.rds")
raw       <- readRDS("./raw_nick_pilot.rds")
ans_tbl   <- readRDS(file = "../../apps/spinifex_study/www/ans_tbl.rds")
resp_ans  <- dplyr::left_join(x = raw, y =  ans_tbl, by = "sim_nm") %>%
    mutate(v5_resp = ifelse(p_dim == "p4", NA_integer_, v5_resp),
           v6_resp = ifelse(p_dim == "p4", NA_integer_, v6_resp))
df_active <- resp_ans[resp_ans$plot_active == TRUE,]
#' @example
#' str(df_active)



#### example from earlier code looking to explain the answer ------

if(F){
    file.edit("./R/MMP_clSep.r") ## See this fiel for the original.
    ## List of ggproto objects
    lab_fill <- "Variable MMP"
    lab_col  <- "Cummulative MMP"
    ret <- list(
        geom_bar(aes(x = var, y = MMP_clSep, fill = lab_fill),
                 df_MMP, position = "dodge", stat = "identity"),
        ## Cumsum clSep
        geom_line(aes(x = as.integer(var), y = cumsum_MMP_clSep,
                      color = lab_col, group = 1),
                  df_MMP, lwd = 1.2),
        geom_point(aes(x = as.integer(var), y = cumsum_MMP_clSep,
                       color = lab_col),
                   df_MMP, shape = 18, size = 4),
        ## Titles and colors
        labs(x = "Variable", y = "Cluster seperation"),
        theme(axis.text.x = element_text(angle = 30),
              legend.position = "bottom",
              legend.direction = "vertical"),
        scale_fill_manual(values = palette()[1],
                          name = "", labels = lab_fill),
        scale_colour_manual(values = palette()[2],
                            name = "", labels = lab_col)
    )
    
    ## Add answer overlay if requested
    if (do_overlay_answer == TRUE){
        p <- ncol(data)
        bar_unif <- 1 / p
        
        df_MMP$exampleResponse <- sample(c(0,1), size = p, replace = TRUE)
        df_MMP_eval <- df_MMP %>% 
            dplyr::mutate(.keep = "all",
                          diff   = MMP_clSep - bar_unif,
                          weight = sign(diff) * sqrt(abs(diff)),
                          marks  = weight * exampleResponse) %>% 
            dplyr::arrange(desc(MMP_clSep))
        
        col <- dplyr::if_else(sign(df_MMP_eval$diff) == 1, "green", "red")
        ggproto_overlay <- 
            list(
                geom_hline(yintercept = bar_unif, size = 1), 
                geom_text(aes(x = 7, y = bar_unif + .03, 
                              label = paste0("Uniform Wt, 1/p = ", bar_unif)),
                          size = 4, hjust = 1), 
                geom_segment(data = df_MMP_eval, colour = col, size = 2,
                             aes(x = 1:p, y = bar_unif, 
                                 xend = 1:p, yend = weight + bar_unif))
            )
    }
}
```

## Speed and marks

```{r}
(marks <- ggplot(df_active, aes(x = factor, y = task_marks)) + 
     geom_boxplot() +
     geom_jitter(width = .2, height = .05) + 
     labs(title = "Marks by factor") + theme_minimal() + 
     scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))
print("I think the relatively low marks in radial comes from overconfidence do to the stark difference in bases. Discuss the 'half clock' layout.")
print("also note that the respose table was made with the wrong perm offset number. idk if this would be a consistent error with what the app asks for or not.")

print("Radial basis 'Half clock':")
knitr::include_graphics("./half_clock.png", dpi = 70)


(speed <- ggplot(df_active, aes(x = factor, y = ttr)) +
        geom_boxplot() +
        geom_jitter(width = .2, height = .05) +
        labs(title = "seconds on page of last response by factor") + theme_minimal() +
        scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))
print("Numbers these high don't make sense, Timer is being asked to be reset with every page. Looking at the sheet, ttr is monotonically increasing, this is most accuately time from opening app.")
print("This has been fixed.")
```

## Input and Response interactions

```{r}
(input_interactions <- ggplot(df_active, aes(x = factor, y = input_inter)) + 
     geom_boxplot() +
     geom_jitter(width = .2, height = .05) + 
     labs(title = "Number of input interaction by factor (throughness)") + theme_minimal() + 
     scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))

(response_interactions <- ggplot(df_active, aes(x = factor, y = resp_inter)) + 
        geom_boxplot() +
        geom_jitter(width = .2, height = .05) + 
        labs(title = "Number of input interaction by factor (1/confidence)") + theme_minimal() + 
        scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))
print("I'm going to circle back to this to see if it's capturing correctly.")
```

## Reviewing marks outside of +/- 1
```{r}
## Filter to rows outside of the expected +/- 1
issue_sub <- df_active %>%
    filter(abs(task_marks) > 1)
## Many pivot longer and join
resp_longer <- issue_sub %>%
    select(c(key, sim_nm, bar, v1_resp:v6_resp)) %>%
    pivot_longer(cols = v1_resp:v6_resp,
                 names_to = "var_num",
                 names_prefix  = "var_num",
                 values_to = "resp",
                 values_drop_na = TRUE) %>%
    mutate(var_num = as.factor(substr(var_num, 2, 2)))
marks_longer <- issue_sub %>% 
    select(c(key, sim_nm, v1_marks:v6_marks)) %>%
    pivot_longer(cols = v1_marks:v6_marks,
                 names_to = "var_num",
                 names_prefix  = "var_num",
                 values_to = "marks",
                 values_drop_na = TRUE) %>%
    mutate(var_num = as.factor(substr(var_num, 2, 2)))
signal_longer <- issue_sub %>% 
    select(c(key, sim_nm, v1_signal:v6_signal)) %>%
    pivot_longer(cols = v1_signal:v6_signal,
                 names_to = "var_num",
                 names_prefix  = "var_num",
                 values_to = "signal",
                 values_drop_na = TRUE) %>%
    mutate(var_num = as.factor(substr(var_num, 2, 2)))
diff_longer <- issue_sub %>% 
    select(c(key, sim_nm, v1_diff:v6_diff)) %>%
    pivot_longer(cols = v1_diff:v6_diff,
                 names_to = "var_num",
                 names_prefix  = "var_num",
                 values_to = "diff",
                 values_drop_na = TRUE) %>%
    mutate(var_num = as.factor(substr(var_num, 2, 2)))
weight_longer <- issue_sub %>% 
    select(c(key, sim_nm, v1_weight:v6_weight)) %>%
    pivot_longer(cols = v1_weight:v6_weight,
                 names_to = "var_num",
                 names_prefix  = "var_num",
                 values_to = "weight",
                 values_drop_na = TRUE) %>%
    mutate(var_num = as.factor(substr(var_num, 2, 2)))
## cbind(), left_join not working.
issue_sub_longer <- NA
if(all.equal(
    dim(resp_longer), dim(marks_longer),
    dim(signal_longer), dim(diff_longer), dim(weight_longer)
)){
    issue_sub_longer <- cbind(
        resp_longer, marks_longer[, 4], signal_longer[, 4],
        diff_longer[, 4], weight_longer[, 4])
}else{warning("all dim not equal!!!")}

ggplot(issue_sub_longer, aes(var_num, resp)) + 
    geom_bar(position = "dodge", stat = "identity", fill = "lightblue") + 
    facet_wrap(vars(sim_nm)) + 
    theme_minimal()
```


```{r TEMP-SKRATCHPAD}
str(issue_sub_longer) 
#' @args
#' resp_ans_longer resp_tbl and ans_tbl joined, filtered for plot_active, 
require(ggplot2)
palette(RColorBrewer::brewer.pal(12, "Dark2"))
ggproto_ans_plot <- function(resp_ans_longer){
    ## List of ggproto objects
    lab_fill <- "Varaiable cluster seperation"
    ret <- list(
        ## Boxplot, signal
        geom_bar(aes(x = var_num, y = signal, fill = lab_fill),
                 resp_ans_longer, position = "dodge", stat = "identity"),
        # ## Line and point, cumulative
        # geom_line(aes(x = as.integer(var), y = cumsum_MMP_clSep,
        #                                 color = lab_col, group = 1),
        #                    df_MMP, lwd = 1.2),
        # geom_point(aes(x = as.integer(var), y = cumsum_MMP_clSep,
        #                                  color = lab_col),
        #                 df_MMP, shape = 18, size = 4),
        ## Titles and colors
        labs(x = "Variable number", y = "Value"),
        theme(legend.position = "bottom",
              legend.direction = "vertical"),
        scale_fill_manual(values = palette()[1],
                          name = "", labels = lab_fill),
        scale_colour_manual(values = c("lightgreen", "lightred"),
                            name = "", labels = c("marks (+)", "marks (-)"))
    )
    
    ## Add in the bar and weight
    p <- 6#<- length(unique(resp_ans_longer$var_num))
    bar_unif <- resp_ans_longer$bar
    mark_col <- dplyr::if_else(sign(resp_ans_longer$diff) == 1, "green", "red")
    segment_x <- rep_len(1:p, length.out = nrow(resp_ans_longer))
    ret <- c(ret, 
             list(
                 ## Uniform bar, and text
                 geom_hline(yintercept = bar_unif, size = 1), 
                 geom_text(aes(x = p, y = bar_unif + .04, 
                               label = paste0("Uniform signal, 1/p = ", round(bar_unif, 2))),
                           size = 4, hjust = 1),
                 ## Marks segment
                 geom_segment(data = resp_ans_longer, colour = mark_col, size = 2,
                              aes(x = segment_x, xend = segment_x,
                                  y = bar_unif, yend = weight + bar_unif))
             )
    )
    
    return(ret)
}

ggplot(issue_sub_longer) +
    ggproto_ans_plot(issue_sub_longer) +
    facet_wrap(vars(sim_nm))
```

