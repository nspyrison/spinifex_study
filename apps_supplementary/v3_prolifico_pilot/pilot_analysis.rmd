---
title: "prolifico pilot"
author: "Nick Spyrison"
date: "11/01/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
require(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
rel_path <- function(rel_path){
  rel_dir  <- dirname(rstudioapi::getSourceEditorContext()$path)
  rel_path <- paste0(rel_dir, "/", rel_path)
  normalizePath(rel_path)
}

## Read from gsheets API4 and save local
if(F){
    ss_id <- "1K9qkMVRkrNO0vufofQJKWIJUyTys_8uVtEBdJBL_DzU" ## hash id of the google sheet
    raw <- googlesheets4::read_sheet(ss_id, sheet = 1L)
    raw$full_perm_num <- unlist(raw$full_perm_num)
    v <- rep(NULL, nrow(raw))
    raw$prolific_id <- unlist(as.character(raw$prolific_id))
    #str(raw)
    saveRDS(raw, rel_path("data/raw_prolific_pilot.rds"))
}
## Load load and clean, save cleaned
if(F){
    raw <- readRDS(rel_path("data/raw_prolific_pilot.rds"))
    ## Filter to only task data including training
    dat_active <- raw[raw$plot_active == TRUE, ] %>% 
        filter(!is.na(key))
    ## Pivot variable coulmns longer
    source(rel_path("../../paper/R/pivot_longer_resp_ans_tbl.r"))
    dat_longer <- pivot_longer_resp_ans_tbl(dat = dat_active)
    ## Aggregate to task grain.
    dat_task_agg <- aggregate_task_vars(dat_longer)
    saveRDS(dat_task_agg, rel_path("data/dat_task_agg_prolific_pilot.rds"))
}
## load aggregated data.
dat_task_agg <- readRDS(rel_path("data/dat_task_agg_prolific_pilot.rds"))
##TODO: XXX ___CONTINUE HERE____
```

## Speed and marks

```{r}
(marks <- ggplot(dat_task_agg, aes(x = factor, y = task_marks)) + 
     geom_boxplot() +
     geom_jitter(width = .2, height = .05) + 
     labs(title = "Marks by factor") + theme_minimal() + 
     scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))
print("I think the relatively low marks in radial comes from overconfidence do to the stark difference in bases. Discuss the 'half clock' layout.")
print("also note that the respose table was made with the wrong perm offset number. idk if this would be a consistent error with what the app asks for or not.")

print("Radial basis 'Half clock':")
knitr::include_graphics("./half_clock.png", dpi = 70)


(speed <- ggplot(df_active, aes(x = factor, y = ttr)) +
        geom_boxplot() +
        geom_jitter(width = .2, height = .05) +
        labs(title = "seconds on page of last response by factor") + theme_minimal() +
        scale_color_brewer(palette = "Dark2") + scale_fill_brewer(palette = "Dark2"))
print("Numbers these high don't make sense, Timer is being asked to be reset with every page. Looking at the sheet, ttr is monotonically increasing, this is most accuately time from opening app.")
print("This has been fixed.")
```

## Input and Response interactions

```{r}
(input_interactions <- ggplot(df_active, aes(x = factor, y = input_inter)) +
     geom_boxplot() +
     geom_jitter(width = .2, height = .05) +
     labs(title = "Number of input interaction by factor (throughness)") +
     theme_minimal() + 
     scale_color_brewer(palette = "Dark2") +
     scale_fill_brewer(palette = "Dark2"))

(response_interactions <- ggplot(df_active, aes(x = factor, y = resp_inter)) +
        geom_boxplot() +
        geom_jitter(width = .2, height = .05) +
        labs(title = "Number of input interaction by factor (1/confidence)") +
        theme_minimal() + 
        scale_color_brewer(palette = "Dark2") +
        scale_fill_brewer(palette = "Dark2"))
print("I'm going to circle back to this to see if it's capturing correctly.")
```

## Explaining scoring

```{r TEMP-SKRATCHPAD}
#' @example
#' str(dat) 
#' palette(RColorBrewer::brewer.pal(12, "Dark2"))
#'ggplot(dat) +
#'    ggproto_ans_plot(dat) +
#'    facet_wrap(vars(sim_nm)) + theme_minimal()

## ggproto for the ans_plot
ggproto_ans_plot <- function(resp_ans_longer){
    ## List of ggproto objects
    lab_fill <- "Varaiable cluster seperation"
    ret <- list(
        ## Boxplot, signal
        geom_bar(aes(x = var_num, y = signal, fill = lab_fill),
                 resp_ans_longer, position = "dodge", stat = "identity",
                 width = .5),

        ## Titles and colors
        labs(x = "Variable number", y = "Value"),
        theme(legend.position = "bottom",
              legend.direction = "vertical"),
        scale_fill_manual(
            values = c(palette()[1], "grey80", "lightblue"), name = "",
            labels = c("Varaiable cluster seperation", "selected", "not selected")),
        scale_colour_manual(values = c("green", "red"),
                            name = "", labels = c("marks (+)", "marks (-)"))
    )
    
    ## Add in the bar and weight
    p <- 6#<- length(unique(resp_ans_longer$var_num))
    mark_col <- dplyr::if_else(sign(resp_ans_longer$diff) == 1, "green", "red")
    ret <- c(ret, 
             list(
                 ## Uniform bar, and text
                 geom_hline(aes(yintercept = bar), resp_ans_longer, size = 1), 
                 geom_text(aes(x = p + 1, y = bar + .1, 
                               label = paste0("1/p = ", round(bar, 2))),
                           size = 4, hjust = 1),
                 ## Marks segment
                 geom_segment(aes(x = var_num, xend = var_num,
                                  y = bar, yend = weight + bar),
                              resp_ans_longer, colour = mark_col, size = 2)
             )
    )
    
    return(ret)
}

ggplot(dat) +
    ggproto_ans_plot(dat) +
    facet_wrap(vars(sim_nm)) + theme_minimal()
```

