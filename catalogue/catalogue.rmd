---
title: "Simulating data and it's cluster seperation"
output:
  html_document:
  toc: true
toc_depth: 3
# editor_options:
#   chunk_output_type: console
---
```{r setup_condensed, include=F}
## Setup
require("knitr")
require("spinifex")
require("tourr")
require("ggplot2")
require("tibble")
require("dplyr")
## For kniting
try(source("../R/geom_lda_points.r"), silent = T)
try(source("../R/ggproto_screeplot_pca.r"), silent = T)
try(source("../R/ggproto_screeplot_clSep.r"), silent = T)
try(source("../R/MMP_clSep.r"), silent = T)
## For local
try(source("./R/geom_lda_points.r"), silent = T)
try(source("./R/ggproto_screeplot_pca.r"), silent = T)
try(source("./R/ggproto_screeplot_clSep.r"), silent = T)
try(source("./R/MMP_clSep.r"), silent = T)
knitr::opts_chunk$set(
  echo      = FALSE,
  include   = TRUE,
  message   = FALSE, warning = FALSE, error = FALSE,
  results   = "markup",              # Opts: "asis", "markup", "hold", "hide"
  fig.align = "center",              # Opts: "left", "right", "center", "default"
  fig.width = 8, fig.height = 5,
  out.width = "100%",
  fig.pos   = "h", out.extra   = "", # Figures forced closer to chunk location.
  collapse  = TRUE, cache = TRUE, cache.lazy = FALSE
)

## Global init, and theme
top_n_manual_tours <- 3 ## keeps run time and length of content resonable.
permutation_reps <- 100
DO_GENERATION_RADIAL_TOURS <- F
output_path <- "./output_catalogue/"
set.seed(20200903)
theme_set(theme_minimal())
palette(RColorBrewer::brewer.pal(8, "Dark2"))

## {mclust} setup
if(F) ## For generation see this file:
  file.edit("./catalogue/sim_mclust.r") ## Local only
## Load data
obj_nms <- c("sim_eii", "sim_eee", "sim_vvv")
i_s <- 1:length(obj_nms)
for(i in i_s){
  try(load(file = paste0("./simulations/", obj_nms[i], ".rds")), silent = T)
  try(load(file = paste0("./catalogue/simulations/", obj_nms[i], ".rds")), 
      silent = T)
}
## Context -- simulation information
sim1 <- get(obj_nms[1])
p    <- ncol(sim1)
k_cl <- length(unique(sim1[, 1]))
```

# {mclust} models EII, EEE, and VVV

All models simulated with `r p` dimensions and `r k_cl` clusters. Manual tours for the top `r top_n_manual_tours` variables (in terms of MMP cluster seperation).

## MMP Cluster Seperation
```{r}
for(i in i_s){
  ## Initialize
  sim_nm  <- obj_nms[i]
  sim <- get(sim_nm)
  model_nm <- attr(sim,"modelName")
  dat <- sim[, -1]
  clas <- as.factor(sim[, 1])
  
  #debugonce(ggproto_MMP_clSep)
  ## MMP ClSep
  print(ggplot() + ggproto_MMP_clSep(dat, clas, n_reps = permutation_reps))
  # ## Group means
  # agg <- sim %>%
  #   as_tibble() %>%
  #   group_by(group) %>% 
  #   summarise(
  #     mn1  = mean(x1),
  #     mn2  = mean(x2),
  #     mn3  = mean(x3),
  #     mn4  = mean(x4),
  #     mn5  = mean(x5),
  #     mn6  = mean(x6),
  #     mn7  = mean(x7),
  #     mn8  = mean(x8),
  #     mn9  = mean(x9),
  #     mn10 = mean(x10)
  #   )
  # print(agg)
}
```

## PCA
```{r pca}
for(i in i_s) {
  ## Initialize
  sim_nm  <- obj_nms[i]
  sim <- get(sim_nm)
  model_nm <- attr(sim,"modelName")
  dat <- sim[, -1]
  clas <- as.factor(sim[, 1])
  
  ## PCA
  print(prcomp(dat)$rotation)
  print(ggplot() + ggproto_screeplot_pca(dat))
}
```

## Manual tours
```{r manual_tours}
if(DO_GENERATION_RADIAL_TOURS == TRUE){
  for(i in i_s) {
    ## Initialize
    sim_nm  <- obj_nms[i]
    sim <- get(sim_nm)
    model_nm <- attr(sim,"modelName")
    dat <- sim[, -1]
    clas <- as.factor(sim[, 1])
    
    ## Manual tours
    pca_bas <- as.matrix(prcomp(dat)$rotation[, 1:2])
    mmp_clsep <- df_scree_MMP_clSep(dat, clas, n_reps = permutation_reps)
    tour_manip_nums <- mmp_clsep$data_colnum[1:top_n_manual_tours]
    for (i in 1:length(tour_manip_nums)){
      play_manual_tour(basis = pca_bas,
                       data = dat,
                       fps = 9L,
                       manip_var = tour_manip_nums[i],
                       render_type = render_gganimate,
                       col = clas, pch = clas,
                       axes = "left",
                       gif_filename = paste0("radialTour_", sim_nm, 
                                             "_mvar", tour_manip_nums[i], ".gif"),
                       gif_path = output_path,
                       ggtheme = list(
                         scale_color_manual(values = palette()[1:k_cl]),
                         theme_void()
                       )
      )
    } ## End of for radial tour creation loop
  } ## End of for groups loop
} ## End of if DO_GENERATION_RADIAL_TOURS
```
<!-- ![](output_sim_clSep/radialTour_sim_mvar1.gif) -->
<!-- ![](output_sim_clSep/radialTour_sim_mvar1.gif) -->
<!-- ![](output_sim_clSep/radialTour_sim_mvar1.gif) -->
<!-- ![](output_sim_clSep/radialTour_sim_mvar1.gif) -->


## LDA 
```{r lda}
  for(i in i_s) {
    ## Initialize
    sim_nm  <- obj_nms[i]
    sim <- get(sim_nm)
    model_nm <- attr(sim,"modelName")
    dat <- sim[, -1]
    clas <- as.factor(sim[, 1])
    
  ## LDA
  MASS::lda(dat, grouping = clas)
  if(length(unique(clas)) > 2){
    print(ggplot() + geom_lda_points(dat, clas))
  } else warning("LDA not called, fewer than 2 classes.")
}
```

# {mclust} paper reference

Scrucca, Luca, Michael Fop, T. Brendan Murphy, and Adrian E. Raftery. "Mclust 5: Clustering, Classification and Density Estimation Using Gaussian Finite Mixture Models." The R Journal 8, no. 1 (August 2016): 289-317.

## Table 3 
![](../images/mclust_table3.png)

## Figure 2
![](../images/mclust_figure2.png)


