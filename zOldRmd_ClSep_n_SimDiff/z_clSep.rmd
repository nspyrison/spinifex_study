---
title: "Evaluating task and vet sim difficulty."
output:
  html_document:
    toc: true
    toc_depth: 2
editor_options:
  chunk_output_type: console
---

For S3D and 4D meta-analysis see (K. Kim, et al. 2017).

```{r setup_condensed, include=F}
## Setup
library("knitr")
knitr::opts_chunk$set(
  echo = F,
  message   = FALSE, warning = FALSE, error = FALSE,
  results   = "asis",                # Opts: "asis", "markup", "hold", "hide"
  fig.align = "center",              # Opts: "left", "right", "center", "default"
  fig.width = 8, fig.height = 5,
  out.width = "100%",
  fig.pos   = "h", out.extra   = "", # Figures forced closer to chunk location.
  collapse  = TRUE, cache = FALSE, cache.lazy = FALSE
)
```

```{r init}
## Initialize
require("spinifex")
require("tourr")
require("ggplot2")
require("tibble")
require("dplyr")
source("./R/ggproto_screeplot_pca.r")
source("./R/ggproto_screeplot_clSep.r")
source("./R/permutation_feature_importance.r")
source("./R/sim_pDim_kCl.r") ## cluster levels stored in attribute "cl_lvl". Try attr(mySim, "cl_lvl")
set.seed(20200725)
theme_set(theme_minimal())
palette(RColorBrewer::brewer.pal(8, "Dark2"))
DO_RERUN_HEAVY_OUTPUT            <- FALSE
DO_RERUN_SIM301_PAIRS_n_TOURGIFS <- FALSE


mns  <- list(c(10, 3, rep(0, 3)), c(2, 1, rep(0, 3)))
covs <- list(diag(5), diag(5))
dat  <- sim_pDim_kCl(means = mns,
                     sigmas = covs)

clas <- attr(dat, "cl_lvl")
clas <- factor(clas, levels = unique(clas))
p    <- ncol(dat)
k_cl <- length(unique(clas))
```


# View
```{r view}
tibble::as_tibble(dat)
str(dat)

for(i in 1:k_cl){
  print(paste("#", i, ", class: "), levels(clas)[i])
  sub <- dat[clas == levels(clas)[i], ]
  print("Within class column means:")
  colmeans(sub)
  print("Within class covariance:")
  GGally::ggcorr(sum, label = TRUE, label_alpha = TRUE)
}
```


# pairs

```{r pairs}
GGally::ggpairs(dat, aes(col = clas))

```

# PCA
```{r pca}
prcomp(dat)
ggplot2::ggplot() + ggproto_screeplot_clSep(dat, clas) + theme_minimal()
```

# LDA
```{r lda}
MASS::lda(dat, grouping = clas)
```


# Cluster seperation

```{r clSepScreeplot}
ggplot2::ggplot() + ggproto_screeplot_clSep(dat, clas) + theme_minimal()
```

## single-variable permuted data

```{r permFeatImp}
if (DO_RERUN_HEAVY_OUTPUT == TRUE) {
  for (i in 1:6) {
    .gg <- ggplot() + ggproto_rep_permute_var_clSep(data = dat, class = clas, permute_rank_num = i)
    ggsave(filename = paste0("permute_clSep", i, ".png"),
           plot =  .gg,
           path = "./output/")
  }
}
```
![](output/permute_clSep1.png)
![](output/permute_clSep2.png)
![](output/permute_clSep3.png)
![](output/permute_clSep4.png)
![](output/permute_clSep5.png)
![](output/permute_clSep6.png)

```{r origxMMP}
if (DO_RERUN_HEAVY_OUTPUT == TRUE) {
  .gg <- ggplot2::ggplot() + ggproto_origxMMP_clSep(data = dat, class = clas)
  ggsave(filename = paste0("origxMMP_clSep.png"),
         plot =  .gg,
         path = "./output/")
}
```
![](output/origxMMP_clSep.png)



```{r MMP}
if (DO_RERUN_HEAVY_OUTPUT == TRUE) {
  .gg <- ggplot2::ggplot() + ggproto_MMP_clSep(data = dat, class = clas)
  ggsave(filename = paste0("MMP_clSep.png"),
         plot =  .gg,
         path = "./output/")
}
```
![](output/MMP_clSep.png)

# Seies 300 simulation difficulty

In order to properly distinguish a difference between the 3 vizualization factors the data must be of suitable complexity, such that it has the following properties:

1. Must be complex enough not to see within the any pair of the first 4 Principal Components; such that PCA is not sufficent for exploring cluster seperation
2. Must not be so complex as to preclude any meaningful response given the factor visuals and time constraints.

Lets try to evaluate our current generation of data simulations against these properties

## User study simulation 301
This was a 300 series simulation done at the end of the generation 1 user study shiny app.

### MMP cluster seperation

```{r sim301clSep}
### Initialization for sim 301, 
dat  <- readRDS("./apps/data/simulation_data301.rds")
clas <- attributes(dat)$cl_lvl
if (DO_RERUN_HEAVY_OUTPUT == TRUE) {
  .gg <- ggplot() + ggproto_MMP_clSep(dat, clas)
  ggsave(filename = paste0("sim301_MMP_clSep.png"),
         plot =  .gg,
         path = "./output/")
}
```
![](output/sim301_MMP_clSep.png)


### PCA

```{r simPcaPairs}
if (DO_RERUN_SIM301_PAIRS_n_TOURGIFS == TRUE) {
  ## Series spans from 301:312
  dat          <- readRDS("./apps/data/simulation_data301.rds")
  dat_clusters <- attributes(dat)$cl_lvl
  dat_std      <- tourr::rescale(as.matrix(dat))
  dat_pca_rot  <- prcomp(dat)$rotation
  proj_dat_pca <- as.data.frame(dat_std %*% dat_pca_rot)
  
  ggparis_proj_dat_pca <- 
    GGally::ggpairs(proj_dat_pca[, 1:4], 
                    title = "ggpairs of PC1:4 for simulation_data301",
                    ggplot2::aes(colour = dat_clusters))
  #+ scale_color_brewer("Dark2") ## scale_color/fill* does not work as explected on ggpairs()
  
  ggplot2::ggsave(filename = "ggpairs_pca_sim301.png",
                  plot =  ggparis_proj_dat_pca,
                  path = "./output/")
}
```
![](output/ggpairs_pca_sim301.png)

Seems sufficent to be complex enough not to be seen as a pair of components within the first 4 Principal Components. Now to see if we can see anything in radial tours of all variables. We view cl Sep to explore which variables should contain contributions.


### Radial tour gifs for each manip var
![](output/radialTour_sim301_mvar1.gif)
![](output/radialTour_sim301_mvar2.gif)
![](output/radialTour_sim301_mvar3.gif)
![](output/radialTour_sim301_mvar4.gif)
![](output/radialTour_sim301_mvar5.gif)
![](output/radialTour_sim301_mvar6.gif)
![](output/radialTour_sim301_mvar7.gif)



